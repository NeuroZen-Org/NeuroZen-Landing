---
import Layout from "../layouts/Layout.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import LanguageSwitcher from "@/components/HeaderComponents/ui/LanguageSwitcher.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const url = new URL(Astro.request.url);
const planName = url.searchParams.get("plan") || t("purchase.notSpecified");
const planPrice = url.searchParams.get("price") || "$0";
---

<Layout title={`${t("purchase.title")} - NeuroZen`}>
  <!-- Language Switcher -->
  <div class="fixed top-6 right-6 z-50">
    <LanguageSwitcher />
  </div>

  <!-- Toast Notification -->
  <div
    id="toast"
    class="fixed top-4 left-1/2 -translate-x-1/2 z-50 opacity-0 pointer-events-none transition-all duration-300 transform -translate-y-full"
  >
    <div
      class="bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[320px]"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-6 h-6 flex-shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
        <p class="font-semibold">{t("purchase.success")}</p>
        <p class="text-sm text-green-100">
          Redirigiendo a la página principal...
        </p>
      </div>
    </div>
  </div>

  <div class="min-h-screen bg-gradient-to-b from-green-50 to-white py-12 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">
          {t("purchase.title")}
        </h1>
        <p class="text-gray-600">
          Estás a un paso de mejorar tu bienestar con NeuroZen
        </p>
      </div>

      <!-- Plan Selected -->
      <div class="bg-white rounded-2xl shadow-lg p-8 border-2 border-green-500">
        <div class="flex justify-between items-center">
          <div>
            <h2 id="plan-name" class="text-2xl font-bold text-gray-800 mb-2">
              {planName || "Cargando..."}
            </h2>
            <p class="text-gray-600">{t("purchase.plan")}</p>
          </div>

          <div class="text-right">
            <p id="plan-price" class="text-3xl font-bold text-green-600">
              {planPrice || "$0"}
            </p>
            <p class="text-sm text-gray-500">por mes</p>
          </div>
        </div>
      </div>

      <div class="min-h-screen bg-gradient-to-b from-green-50 to-white py-12">
        <div class="max-w-4xl mx-auto">
          <!-- Purchase Form -->
          <div class="bg-white rounded-2xl shadow-lg p-8">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6">
              Información de pago
            </h3>

            <form class="space-y-6">
              <!-- Información Personal -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="firstName"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    {t("purchase.form.name")}
                  </label>
                  <input
                    type="text"
                    id="firstName"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                    placeholder={t("purchase.form.name.placeholder")}
                  />
                </div>
                <div>
                  <label
                    for="lastName"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Apellido
                  </label>
                  <input
                    type="text"
                    id="lastName"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                    placeholder="Pérez"
                  />
                </div>
              </div>

              <div>
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  {t("purchase.form.email")}
                </label>
                <input
                  type="email"
                  id="email"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                  placeholder={t("purchase.form.email.placeholder")}
                />
              </div>

              <!-- Información de Tarjeta -->
              <div class="border-t pt-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">
                  Información de tarjeta
                </h4>

                <div class="space-y-4">
                  <div>
                    <label
                      for="cardNumber"
                      class="block text-sm font-medium text-gray-700 mb-2"
                    >
                      {t("purchase.form.card")}
                    </label>
                    <input
                      type="text"
                      id="cardNumber"
                      required
                      maxlength="19"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                      placeholder={t("purchase.form.card.placeholder")}
                    />
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label
                        for="expiry"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        {t("purchase.form.expiry")}
                      </label>
                      <input
                        type="text"
                        id="expiry"
                        required
                        maxlength="5"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                        placeholder={t("purchase.form.expiry.placeholder")}
                      />
                    </div>
                    <div>
                      <label
                        for="cvv"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        {t("purchase.form.cvv")}
                      </label>
                      <input
                        type="text"
                        id="cvv"
                        required
                        maxlength="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                        placeholder={t("purchase.form.cvv.placeholder")}
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Submit Button -->
              <button
                type="submit"
                class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold text-lg rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-[1.02]"
              >
                {t("purchase.form.submit")}
              </button>
            </form>

            <!-- Security Info -->
            <div
              class="mt-6 flex items-center justify-center gap-2 text-sm text-gray-500"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                ></path>
              </svg>
              <span>Pago seguro y encriptado</span>
            </div>
          </div>

          <!-- Back Link -->
          <div class="text-center mt-8">
            <a
              href="/#planes"
              class="text-green-600 hover:text-green-700 font-medium transition-colors duration-200"
            >
              ← Volver a planes
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Translation map for plan names
  const planTranslations: Record<string, Record<string, string>> = {
    es: {
      Basic: "Básico",
      Básico: "Básico",
      Advanced: "Avanzado",
      Avanzado: "Avanzado",
      "Professional (Zen+)": "Professional (Zen+)",
    },
    en: {
      Basic: "Basic",
      Básico: "Basic",
      Advanced: "Advanced",
      Avanzado: "Advanced",
      "Professional (Zen+)": "Professional (Zen+)",
    },
  };

  // Obtener parámetros de la URL desde el cliente
  const urlParams = new URLSearchParams(window.location.search);
  const planNameParam = urlParams.get("plan") || "Plan no especificado";
  const planPrice = urlParams.get("price") || "$0";

  // Get current language from URL
  const currentLang = window.location.pathname.startsWith("/en") ? "en" : "es";

  // Translate plan name
  const planName =
    planTranslations[currentLang][planNameParam] || planNameParam;

  // Actualizar el DOM con los valores
  const planNameElement = document.getElementById("plan-name");
  const planPriceElement = document.getElementById("plan-price");

  if (planNameElement) {
    planNameElement.textContent = planName;
  }

  if (planPriceElement) {
    planPriceElement.textContent = planPrice;
  }

  // Actualizar el título de la página
  document.title = `Comprar ${planName} - NeuroZen`;

  // Formatear número de tarjeta
  const cardNumberInput = document.getElementById(
    "cardNumber"
  ) as HTMLInputElement;
  cardNumberInput?.addEventListener("input", (e) => {
    const target = e.target as HTMLInputElement;
    let value = target.value.replace(/\s/g, "");
    let formattedValue = value.match(/.{1,4}/g)?.join(" ") || value;
    target.value = formattedValue;
  });

  // Formatear fecha de expiración
  const expiryInput = document.getElementById("expiry") as HTMLInputElement;
  expiryInput?.addEventListener("input", (e) => {
    const target = e.target as HTMLInputElement;
    let value = target.value.replace(/\D/g, "");
    if (value.length >= 2) {
      value = value.slice(0, 2) + "/" + value.slice(2, 4);
    }
    target.value = value;
  });

  // Solo números en CVV
  const cvvInput = document.getElementById("cvv") as HTMLInputElement;
  cvvInput?.addEventListener("input", (e) => {
    const target = e.target as HTMLInputElement;
    target.value = target.value.replace(/\D/g, "");
  });

  // Función para mostrar el toast
  function showToast() {
    const toast = document.getElementById("toast");
    if (!toast) return;

    // Mostrar el toast
    toast.classList.remove(
      "opacity-0",
      "pointer-events-none",
      "-translate-y-full"
    );
    toast.classList.add("opacity-100", "translate-y-0");

    // Ocultar y redirigir después de 2 segundos
    setTimeout(() => {
      toast.classList.add("opacity-0", "-translate-y-full");

      // Redirigir a la landing
      setTimeout(() => {
        window.location.href = "/";
      }, 300); // Esperar a que termine la animación
    }, 2000);
  }

  // Handle form submission
  const form = document.querySelector("form");
  form?.addEventListener("submit", (e) => {
    e.preventDefault();
    showToast();
  });
</script>
